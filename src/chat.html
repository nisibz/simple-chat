<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 h-screen flex items-center justify-center">
    <div class="bg-white shadow-lg rounded-lg p-6 w-full max-w-md space-y-4">
      <div class="text-2xl font-bold text-center">Chat Room</div>

      <div id="onlineTotal" class="text-center text-sm text-gray-500">0</div>

      <div class="space-y-2">
        <input
          type="text"
          id="senderInput"
          placeholder="Type your name..."
          class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"
        />
        <input
          type="text"
          id="roomInput"
          placeholder="Type your room..."
          class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"
        />
        <button
          id="joinRoomButton"
          class="w-full bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700"
        >
          Join Room
        </button>
      </div>

      <div class="space-y-2">
        <input
          type="text"
          id="messageInput"
          placeholder="Type your message..."
          class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"
        />
        <button
          id="sendButton"
          class="w-full bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
        >
          Send Message
        </button>
      </div>

      <ul
        id="messages"
        class="h-80 overflow-y-auto bg-gray-50 p-4 border border-gray-200 rounded space-y-2"
      >
        <!-- Messages will appear here -->
      </ul>
    </div>

    <script src="https://cdn.socket.io/4.0.1/socket.io.js"></script>
    <script>
      const socket = io();

      const senderInput = document.getElementById("senderInput");
      const roomInput = document.getElementById("roomInput");
      const joinRoomButton = document.getElementById("joinRoomButton");
      const onlineTotal = document.getElementById("onlineTotal");

      joinRoomButton.addEventListener("click", () => {
        const room = roomInput.value;

        // Remove all child nodes from the "messages" element
        while (messages.firstChild) {
          messages.removeChild(messages.firstChild);
        }

        socket.emit("join room", room);
      });

      const messageInput = document.getElementById("messageInput");
      const sendButton = document.getElementById("sendButton");
      const messages = document.getElementById("messages");

      sendButton.addEventListener("click", () => {
        const sender = senderInput.value;
        const message = messageInput.value;
        const created = new Date();
        const newMsg = { sender: sender, message: message, created: created };
        socket.emit("chat message", newMsg, roomInput.value);
        messageInput.value = "";
      });

      socket.on("chat message", (msg) => {
        const li = document.createElement("li");

        const currentUser = senderInput.value;
        const messageAlignment =
          msg.sender === currentUser ? "text-right" : "text-left";
        const messageBgColor =
          msg.sender === currentUser ? "bg-green-100" : "bg-blue-100";

        li.className = `${messageAlignment} p-2 ${messageBgColor} rounded text-gray-700`;
        li.textContent = `${msg.sender}: ${msg.message} (${new Date(msg.created).toLocaleTimeString()})`;
        messages.appendChild(li);

        // Scroll to the latest message
        messages.scrollTop = messages.scrollHeight;
      });

      socket.on("online users", (users) => {
        onlineTotal.textContent = `Online users: ${users.count}`;
      });
    </script>
  </body>
</html>
